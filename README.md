# osm-intro

!!! info "Generated by NotebookLM"

This repository details an end-to-end mini-pipeline for processing and visualizing OpenStreetMap (OSM) road data for Cyprus. The project serves as a **practical, rapid introduction to geospatial data processing, analysis, and visualization**, culminating in interactive web maps and laying groundwork for advanced routing and business intelligence capabilities.

The user managed to bootstrap the entire pipeline and produce initial metrics in **less than 4 hours**, demonstrating a swift setup for a functional geospatial data stack.

## What Was Built & Achieved

The core objective was to transform raw OpenStreetMap data into a usable and renderable format. This involved:

*   **Setting up a Geospatial Lab**: A disposable geospatial database lab was **bootstrapped in WSL2** using **Docker-ized PostGIS 15 + 3.4**. This included enabling PostGIS, pgRouting, and hstore extensions.
*   **Efficient OSM Data Ingestion**: Cyprus OSM PBF data was loaded into PostGIS using `osm2pgsql`. A **custom Lua flex configuration** was key, filtering the import to include only road-related data (way_id, highway, name, maxspeed, geom), which **dramatically cut disk/RAM usage and ingest time**.
*   **First Metric Generation**: Approximately **153,000 road geometries** were pulled into GeoPandas. An **H3 resolution-8 hex grid** (approximately 0.6 km² per cell) was generated to cover Cyprus. Roads were then **spatially joined to these hexes**, and the total centerline kilometers per cell were aggregated, providing a foundational metric.
*   **Optimized Database Performance**: The database schema was significantly sped up by adding **targeted B-tree, trigram, and SP-GiST indexes** to the `roads` table, which delivered **10-100x query speed-ups**.
*   **Continuous Data Freshness**: The pipeline was configured for **minute-diff replication** using `osm2pgsql-replication`, allowing continuous updates to the road data.
*   **Database Observability**: PostGIS was instrumented with `pg_stat_statements` to profile heavy SQL queries and monitor performance during updates.
*   **Vector Tile Generation**: Lightweight GeoJSON layers for roads and the hex choropleth were exported from PostGIS in **EPSG 4326** to ensure compatibility with downstream tools and avoid re-projection. These GeoJSON files were then converted into **vector tiles** (MBTiles) using **Tippecanoe**, covering zoom levels 6 (island-wide) to 14 (street level). The MBTiles were subsequently converted to the single-file **PMTiles format** using `pmtiles convert`.
*   **Web-based Visualization**: The generated PMTiles were served locally using `go-pmtiles serve` (or a Python HTTP range reads server). A minimal **MapLibre-GL** web page was then used to load and style these tiles, enabling interactive mapping directly in a browser.

## Key Tools Utilized

This project leverages a range of powerful open-source geospatial and data management tools:

*   **Docker** & **PostGIS**: For containerized, disposable geospatial database environments.
*   **osm2pgsql**: The primary tool for importing OpenStreetMap PBF data into PostGIS and managing continuous updates.
*   **Python (GeoPandas, H3, Shapely, SQLAlchemy, psycopg[binary])**: A crucial environment for data manipulation, spatial analysis, H3 hex grid generation, and database interaction.
*   **GDAL / ogr2ogr**: The "Swiss-army knife" for converting and exporting geospatial data between various formats.
*   **Tippecanoe**: Used for building highly performant vector tiles from GeoJSON data.
*   **go-pmtiles** & **`pmtiles convert`**: Tools for serving and converting vector tile formats, specifically optimizing for web delivery.
*   **MapLibre-GL**: A client-side JavaScript library for rendering interactive vector maps in web browsers.
*   **PostgreSQL Client Utilities (pgcli, pspg)**: Command-line interfaces for efficient database management and querying.

## Core Geospatial Concepts Explained

*   **H3 (Uber's Hierarchical Hexagonal Spatial Index)**: A system that discretizes the Earth's surface into a hierarchical grid of hexagonal cells.
    *   It uses a **spherical icosahedron** (a 20-faced geometric shape) as its base, projecting each face onto a 2D plane.
    *   **CoordIJK** is a local 2D coordinate system within each hexagonal grid, relative to an origin.
    *   **FaceIJK** combines a face number (0-19) with a CoordIJK, serving as an intermediate step for converting between latitude/longitude and H3 cell IDs.
    *   H3 builds hexagons hierarchically: each higher resolution subdivides hexes into smaller ones (each hex into 7 children), supporting resolutions up to 15 (approximately 1m² hexes).
    *   It employs **gnomonic projection**, which preserves straight lines but introduces some distortion in distances and areas, especially at lower resolutions or near face edges. This distortion is bounded and generally acceptable for most practical applications.
*   **EPSG / CRS (Coordinate Reference System)**: Standard codes identifying how spatial coordinates relate to the real world.
    *   **EPSG:4326 (WGS-84)** defines latitude/longitude coordinates, commonly used by GPS and most web APIs.
    *   **EPSG:3857 (Web-Mercator)** defines coordinates in meters, optimized for "slippy map" tiling schemes. `osm2pgsql` often imports data in EPSG:3857 for performance with web maps, but transformation to EPSG:4326 is crucial for consistency with H3 grids and for web rendering.
*   **PMTiles**: A highly efficient, single-file container format for Mapbox Vector Tiles. It's designed for **HTTP range reads**, allowing portions of the file to be streamed directly from cloud storage (e.g., a GCS bucket) without requiring a dedicated tile server. This results in smaller archives and faster tile load times compared to traditional MBTiles.
*   **PostgreSQL Indexing (GiST / SP-GiST)**: `GiST` (Generalized Search Trees) and `SP-GiST` are advanced indexing methods in PostgreSQL specifically designed to accelerate spatial queries on geometry data. `SP-GiST` is noted as being particularly efficient for point and line bounding box operations.

## Future Work & Extensions (Tentative)

The project lays a robust foundation, with several logical next steps planned:

*   **Scaling Up**: Expanding the pipeline from Cyprus to a larger region (e.g., a continent like Europe), involving scaling `osm2pgsql` resources and potentially storing H3 metrics in cloud data warehouses like DuckDB or BigQuery.
*   **Integrating More Data Layers**: Adding more OpenStreetMap data layers such as Points of Interest (POIs), elevation contours, or land/sea masks, and making them toggleable in MapLibre.
*   **Real-time Freshness**: Implementing hourly `osm2pgsql-replication` updates and regenerating only the affected H3 hexes and PMTiles atomically for near real-time data freshness.
*   **Routing & ETA Analytics**: Integrating **OSRM (Open Source Routing Machine)** to provide routing endpoints and logging query latencies. This data can then be aggregated per H3 cell and visualized in **Superset dashboards** to create heatmaps of routing requests, analyze latency, and even detect "missing roads" that cause routing failures.
*   **Cloud Migration**: Transitioning PMTiles hosting to a public cloud storage bucket (e.g., Google Cloud Storage) with CDN caching, and migrating PostGIS to a managed database service for production-readiness.
*   **User-facing API**: Developing a FastAPI microservice to expose the H3 hex metrics and OSRM routing results via a user-friendly API.
*   **Data-quality Feedback Loop**: Establishing a process to automatically flag hexes with zero road length but high OSRM "nearest" hits, providing valuable feedback for OpenStreetMap editors to improve data quality.
```
